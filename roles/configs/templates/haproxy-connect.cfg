global
  log stdout format raw local0
  tune.ssl.default-dh-param 2048
  ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tlsv12
  ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11 no-tlsv12

defaults
  mode http
  option dontlognull
  option http-server-close
  timeout connect 5s
  timeout client 60s
  timeout server 60s
  log-format "{\"ts\":\"%t\",\"ip\":\"%ci\",\"server\":\"%s\",\"http\":{\"request\":\"%r\",\"status\":%ST,\"bytes\":%B},\"tls_front\":{\"enabled\":%[ssl_fc],\"protocol\":\"%[ssl_fc_protocol]\",\"sni\":\"%[ssl_fc_sni]\",\"client_cert_present\":%[ssl_c_used],\"client_verify_code\":%[ssl_c_verify],\"client_cn\":\"%[ssl_c_s_dn(cn)]\",\"client_subject\":\"%[ssl_c_s_dn]\",\"client_issuer\":\"%[ssl_c_i_dn]\"},\"timings\":{\"total_ms\":%Tt,\"connect_ms\":%Tc,\"handshake_ms\":%Th,\"queue_ms\":%Tw,\"response_ms\":%Tr} }"

frontend fe_kafka_connect
  bind 0.0.0.0:9040 ssl crt /etc/haproxy/certs/node-00.intel.r7g.org.pem ca-file /etc/haproxy/certs/ca.crt verify optional
  http-request deny if !{ ssl_c_verify 0 }
  use_backend be_10 if { srv_is_up(be_10/node10) }
  use_backend be_11 if { srv_is_up(be_11/node11) }
  use_backend be_12 if { srv_is_up(be_12/node12) }
  default_backend be_10

backend be_10
  mode http
  http-request set-header Host node-10.intel.r7g.org
  option httpchk GET /health
  http-check send hdr Host node-10.intel.r7g.org
  http-check expect status 200
  http-after-response set-header X-Upstream-Node node-10.intel.r7g.org
  server node10 node-10.intel.r7g.org:9041 ssl crt /etc/haproxy/certs/users/admin/admin.pem ca-file /etc/haproxy/certs/ca.crt verify required sni str(node-10.intel.r7g.org) check check-ssl inter 15s fall 1 rise 2

backend be_11
  mode http
  http-request set-header Host node-11.intel.r7g.org
  option httpchk GET /health
  http-check send hdr Host node-11.intel.r7g.org
  http-check expect status 200
  http-after-response set-header X-Upstream-Node node-11.intel.r7g.org
  server node11 node-11.intel.r7g.org:9041 ssl crt /etc/haproxy/certs/users/admin/admin.pem ca-file /etc/haproxy/certs/ca.crt verify required sni str(node-11.intel.r7g.org) check check-ssl inter 15s fall 1 rise 2

backend be_12
  mode http
  http-request set-header Host node-12.intel.r7g.org
  option httpchk GET /health
  http-check send hdr Host node-12.intel.r7g.org
  http-check expect status 200
  http-after-response set-header X-Upstream-Node node-12.intel.r7g.org
  server node12 node-12.intel.r7g.org:9041 ssl crt /etc/haproxy/certs/users/admin/admin.pem ca-file /etc/haproxy/certs/ca.crt verify required sni str(node-12.intel.r7g.org) check check-ssl inter 15s fall 1 rise 2
