---
- name: Ensure Config directory exists on nodes
  tags:
    - configs_generate
  ansible.builtin.file:
    path: "{{ node_config_path }}"
    state: directory
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: "{{ chmod_configs }}"

- name: Determine template dynamically
  tags: configs_generate
  when: "'central' not in group_names"
  set_fact:
    selected_template: "server_properties_{{ (group_names | difference(['all','cluster','central']))[0] }}.j2"

- name: Deploy Config files to nodes
  tags: configs_generate
  when: "'central' not in group_names"
  ansible.builtin.template:
    src: "{{ selected_template }}"
    dest: "{{ node_config_file }}"
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: "{{ chmod_configs }}"

- name: Deploy topic-maker script
  tags: configs_generate
  when: "'connect' in group_names"
  ansible.builtin.copy:
    src: "topic-maker.sh"
    dest: "{{ node_config_path }}/topic-maker.sh"
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: "0755"

- name: Deploy Balancer Schema config
  tags: configs_generate
  when: inventory_hostname == "node-00"
  run_once: true
  ansible.builtin.template:
    src: "balancer_schema.j2"
    dest: "{{ hostvars['node-00']['node_config_path'] }}/balancer-schema.yaml"
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: '{{ chmod_configs }}'

- name: Deploy Balancer Connect config
  tags: configs_generate
  when: inventory_hostname == "node-00"
  run_once: true
  ansible.builtin.template:
    src: "balancer_connect.j2"
    dest: "{{ hostvars['node-00']['node_config_path'] }}/balancer-connect.yaml"
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: '{{ chmod_configs }}'

- name: Deploy Balancer KSQL config
  tags: configs_generate
  when: inventory_hostname == "node-00"
  run_once: true
  ansible.builtin.template:
    src: "balancer_ksql.j2"
    dest: "{{ hostvars['node-00']['node_config_path'] }}/balancer-ksql.yaml"
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: '{{ chmod_configs }}'

- name: Deploy KPOW-CE console config
  tags: configs_generate
  when: inventory_hostname == "node-00"
  run_once: true
  ansible.builtin.template:
    src: "kpow_ce_console.j2"
    dest: "{{ hostvars['node-00']['node_config_path'] }}/kpow_ce_console.env"
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: '{{ chmod_configs }}'

- name: Deploy KPOW-CE proxy config
  tags: configs_generate
  when: inventory_hostname == "node-00"
  run_once: true
  ansible.builtin.template:
    src: "kpow_ce_proxy.j2"
    dest: "{{ hostvars['node-00']['node_config_path'] }}/kpow_ce_proxy.conf"
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: '{{ chmod_configs }}'