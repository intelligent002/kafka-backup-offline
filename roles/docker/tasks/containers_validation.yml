---
- name: Assign node roles based on inventory group
  tags:
    - containers_validation
    - data_backup
    - data_format
    - data_restore
  set_fact:
    group_roles: "{{ group_roles | default({}) | combine({item: hostvars[item]['group_names'] | difference(['cluster'])}) | first }}"
  with_items: "{{ startup_order }}"
  loop_control:
    label: "{{ item }}"
  run_once: true
  delegate_to: localhost

- name: Check if the containers are running
  tags:
    - containers_validation
    - data_backup
    - data_format
    - data_restore
  shell: "docker inspect -f '{{ '{{.State.Running}}' }}' {{ hostvars[inventory_hostname]['hostname'] }}-{{ group_roles[item] }}"
  register: container_status
  failed_when: false  # Avoid marking the task as failed
  changed_when: false # Do not mark it as a change

- name: Fail if containers are still running
  tags:
    - containers_validation
    - data_backup
    - data_format
    - data_restore
  fail:
    msg: "Container {{ hostvars[inventory_hostname]['hostname'] }} on {{ inventory_hostname }} is still running. Please stop all containers before proceeding."
  when: container_status.stdout | trim | lower == "true"
  any_errors_fatal: true