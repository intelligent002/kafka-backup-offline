---
- name: Gather facts for all nodes
  tags:
    - containers_run
  setup:
  delegate_to: "{{ item }}"
  with_items: "{{ startup_order }}"

- name: Ensure RAM data is stored correctly per node
  tags:
    - containers_run
  set_fact:
    node_ram: "{{ node_ram | default({}) | combine({ item: (ansible_facts['memtotal_mb'] / 1024) | round | int }) }}"
  delegate_to: "{{ item }}"
  with_items: "{{ startup_order }}"

- name: Collect and Store RAM data globally on localhost
  tags:
    - containers_run
  set_fact:
    global_node_ram: "{{ global_node_ram | default({}) | combine(node_ram) }}"
  delegate_to: localhost
  run_once: false
  with_items: "{{ startup_order }}"

- name: Debug RAM per node (Using `global_node_ram`)
  tags:
    - containers_run
  debug:
    msg: "Node: {{ item }} - Total RAM: {{ global_node_ram[item] | default('N/A') }} GB"
  with_items: "{{ startup_order }}"
  run_once: true
