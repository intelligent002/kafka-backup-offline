---
- name: Get RAM size of each node
  tags:
    - containers_run
  delegate_to: "{{ item }}"
  shell: "awk '/MemTotal/ {print $2}' /proc/meminfo"
  register: ram_output
  with_items: "{{ startup_order }}"

- name: Compute RAM in GB
  tags:
    - containers_run
  set_fact:
    node_ram_gb: "{{ node_ram_gb | default({}) | combine({ item.item: (item.stdout | int / 1024 / 1024) | round | int }) }}"
  with_items: "{{ ram_output.results }}"
  loop_control:
    label: "{{ item.key }}"  # Show only node names in output
  run_once: true
  delegate_to: localhost
  no_log: true  # Suppress detailed logs

- name: Compute Heap Size
  tags:
    - containers_run
  set_fact:
    node_heap: "{{ node_heap | default({}) | combine({ item.key: heap_size }) }}"
  vars:
    heap_size: >-
      {%- if   item.value <= 2 -%}  256M
      {%- elif item.value <= 4 -%}  512M
      {%- elif item.value <= 8 -%}  1G
      {%- elif item.value <= 16 -%} 2G
      {%- else -%}                  4G
      {%- endif -%}
  with_dict: "{{ node_ram_gb }}"
  loop_control:
    label: "{{ item.key }}"  # Show only node names in output
  run_once: true
  delegate_to: localhost

- name: Log Computed Heap Size
  tags:
    - containers_run
  debug:
    msg: "{{ item.key }} -> Heap Size: {{ item.value }}"
  with_dict: "{{ node_heap }}"
  loop_control:
    label: "{{ item.key }}"  # Show only node names in output
  run_once: true
  delegate_to: localhost
