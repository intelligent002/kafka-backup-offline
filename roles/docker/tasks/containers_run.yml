---
- name: Gather facts for all nodes
  tags:
    - containers_run
  setup:
  when: inventory_hostname in startup_order  # Runs on all nodes

- name: Calculate RAM per node
  tags:
    - containers_run
  set_fact:
    node_ram: "{{ (ansible_memtotal_mb / 1024) | round | int }}"
  when: "'ansible_memtotal_mb' in ansible_facts"
  run_once: false  # Runs on each node separately

- name: Collect RAM data globally
  tags:
    - containers_run
  set_fact:
    global_node_ram: "{{ global_node_ram | default({}) | combine({ item: hostvars[item].node_ram | default(omit) }) }}"
  with_items: "{{ startup_order }}"
  run_once: true  # Runs once on localhost to collect RAM data from all nodes
  when: "hostvars[item].node_ram is defined"

- name: Debug RAM per node
  tags:
    - containers_run
  debug:
    msg: "Node: {{ item }} - Detected RAM: {{ global_node_ram[item] | default('N/A') }} GB"
  with_items: "{{ startup_order }}"
  run_once: true  # Runs once on localhost





- name: Populate node_specs with RAM & Heap Size
  tags:
    - containers_run
  set_fact:
    node_specs: "{{ node_specs | default({}) | combine({ item: { 'node_ram': node_ram, 'heap_size': heap_size } }) }}"
  vars:
    heap_size: >-
      {%- if   node_ram | int <= 2 -%}  256M
      {%- elif node_ram | int <= 4 -%}  512M
      {%- elif node_ram | int <= 8 -%}  1G
      {%- elif node_ram | int <= 16 -%} 2G
      {%- else -%}                      4G
      {%- endif -%}
  with_items: "{{ startup_order }}"


- name: Assign node roles based on inventory group
  tags:
    - containers_run
  set_fact:
    group_roles: "{{ group_roles | default({}) | combine({item: hostvars[item]['group_names'] | difference(['cluster'])}) }}"
  with_items: "{{ startup_order }}"
  run_once: true


- name: Assigned roles map
  tags:
    - containers_run
  debug:
    msg: "Node: {{ item }} - RAM: {{ node_specs[item]['ram_gb'] }} GB - Heap: {{ node_specs[item]['heap_size'] }} - Role: {{ group_roles[item] | join(', ') }}"
  with_items: "{{ startup_order }}"
  run_once: true

- name: Run containers according to assigned roles
  tags:
    - containers_run
  delegate_to: "{{ item }}"
  run_once: true
  shell: >
    {% if 'controllers' in group_roles[item] %} {{ docker_command_controllers_run }}
    {% elif 'brokers' in group_roles[item] %} {{ docker_command_brokers_run }}
    {% elif 'connect' in group_roles[item] %} {{ docker_command_connect_run }}
    {% else %} echo 'Undefined group, no command executed'
    {% endif %}
  with_items: "{{ startup_order }}"
  when: group_roles[item] is defined

- name: Deploy Connect Balancer on node-0
  tags: containers_run
  delegate_to: node-0
  run_once: true
  shell: >
    {{ docker_command_balancer_run }}
