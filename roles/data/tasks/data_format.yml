---
- name: Validate containers status
  tags:
    - data_format
  # all of them, not only controllers and brokers, lets be on the safe side
  when: "'cluster' in group_names"
  include_tasks: ../../docker/tasks/containers_validation.yml

- name: Remove Cluster Data Folders on nodes
  tags:
    - data_format
  # all the cluster uses /data/cluster/data folders, but only controller and broker should be formatted
  when: "'cluster' in group_names"
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ node_data_store }}"
    - "{{ node_logs_path }}"
    #  those two are under "{{ node_data_store }}"
    #- "{{ node_meta_path }}"
    #- "{{ node_data_path }}"

- name: Create Cluster Data Folders on nodes
  tags:
    - data_format
  # all the cluster uses /data/cluster/data folders, but only controller and broker should be formatted
  when: "'cluster' in group_names"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ owner_user_data }}"
    group: "{{ owner_group_data }}"
    mode: "{{ chmod_data }}"
  loop:
    - "{{ node_data_store }}"
    - "{{ node_meta_path }}"
    - "{{ node_data_path }}"
    - "{{ node_logs_path }}"

- name: Format Data on nodes
  tags:
    - data_format
  when: "'controllers' in group_names or 'brokers' in group_names"
  docker_container:
    name: "{{ item.name }}"
    hostname: "{{ item.hostname }}"
    image: "{{ item.image }}"
    command: "{{ item.command | default(omit) }}"
    state: started
    restart_policy: "{{ item.restart_policy | default('always') }}"
    auto_remove: "{{ item.auto_remove | default(omit) }}"
    memory: "{{ item.memory | default(omit) }}"
    ports: "{{ item.ports | default(omit) }}"
    env: "{{ item.env | default(omit) }}"
    env_file: "{{ item.env_file | default(omit) }}"
    volumes: "{{ item.volumes | default(omit) }}"
    healthcheck: "{{ item.healthcheck | default(omit) }}"
  loop: "{{ kafka_data_format }}"
  loop_control:
    label: "{{ hostvars[inventory_hostname].hostname }}"










