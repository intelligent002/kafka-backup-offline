---
- name: Fetch first node from the cluster
  tags:
    - credentials_apply
  set_fact:
    first_node: >-
      {{
        (groups['combined'] | default([])) |
        union(groups['brokers'] | default([])) |
        first
      }}

- name: Apply ACLs for each user on the first node of the cluster
  tags:
    - credentials_apply
  delegate_to: "{{ first_node }}"
  with_subelements:
    - "{{ credentials }}"
    - permissions
  shell: |
    docker exec {{ first_node }} bash -c "
      JMX_PORT=9997 \
      KAFKA_JMX_OPTS='-Dcom.sun.management.jmxremote.port=9997 \
                      -Dcom.sun.management.jmxremote.rmi.port=9997 \
                      -Dcom.sun.management.jmxremote.authenticate=false \
                      -Dcom.sun.management.jmxremote.ssl=false' \
      kafka-acls --bootstrap-server localhost:9092 \
      --add \
      --allow-principal User:{{ item.0.username }} \
      --operation {{ item.1.operation }} \
      --{{ item.1.resource_type }} {{ item.1.resource_name }}"
