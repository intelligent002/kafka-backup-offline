---
- name: Determine the group for the host dynamically
  tags: containers_run
  delegate_to: "{{ item }}"
  set_fact:
    relevant_group: "{{ item }}"
  with_items: "{{ group_names }}"
  when: item not in ['all', 'cluster', 'central']
  run_once: false

- name: Debug selected relevant group (Before Use)
  tags: containers_run
  delegate_to: "{{ item }}"
  debug:
    msg: "Relevant Group: {{ relevant_group | default('NOT SET') }}"

- name: Select the Docker command dynamically based on the group
  tags: containers_run
  delegate_to: "{{ item }}"
  set_fact:
    selected_docker_command: "{{ docker_run_role[relevant_group] | string | ansible.builtin.template }}"
  when: relevant_group in docker_run_role

- name: Run Docker containers for the assigned role
  tags: containers_run
  shell: "{{ selected_docker_command }}"
  delegate_to: "{{ item }}"
  when: selected_docker_command is defined

#- name: Run docker containers in startup order
#  tags:
#    - containers_run
#  shell: "{{ docker_command_containers_run }}"
#  delegate_to: "{{ item }}"
#  with_items: "{{ startup_order }}"
#  run_once: true  # Ensure task runs only once on localhost
