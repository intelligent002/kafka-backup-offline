---
- name: Verify certificate fullchain present on central
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  stat:
    path: "{{ certificate_file_fullchain }}"
  register: cert_stat_fullchain

- name: Fail if certificate fullchain does not exist
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  fail:
    msg: "The specified certificate fullchain {{ certificate_file_fullchain }} does not exist!"
  when: not cert_stat_fullchain.stat.exists

- name: Verify certificate key present on central
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  stat:
    path: "{{ certificate_file_key }}"
  register: cert_stat_key

- name: Fail if certificate key does not exist
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  fail:
    msg: "The specified certificate key {{ certificate_file_key }} does not exist!"
  when: not cert_stat_key.stat.exists

- name: Verify certificate CA present on central
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  stat:
    path: "{{ certificate_file_ca }}"
  register: cert_stat_ca

- name: Fail if certificate CA does not exist
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  fail:
    msg: "The specified certificate CA {{ certificate_file_ca }} does not exist!"
  when: not cert_stat_ca.stat.exists

- name: Get certificate expiration date
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  shell: >
    openssl x509 -enddate -noout -in {{ certificate_file_fullchain }}
    | sed 's/^notAfter=//'
  register: cert_expiration_date

- name: Debug the raw certificate expiration date
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  debug:
    msg: "Raw certificate expiration date: {{ cert_expiration_date.stdout }}"

- name: Convert expiration timestamp to epoch time (UTC)
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  set_fact:
    certificate_expiration_epoch: >-
      {{ (cert_expiration_date.stdout | to_datetime('%b %d %H:%M:%S %Y %Z')).timestamp() | int }}

- name: Debug the expiration epoch time
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  debug:
    msg: "Expiration epoch time: {{ certificate_expiration_epoch }}"

- name: Debug the difference between expiration and current epoch times
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  debug:
    msg: >
      Expiration epoch time: {{ certificate_expiration_epoch | float }},
      Current epoch time: {{ ansible_date_time.epoch }},
      Difference in seconds: {{ certificate_expiration_epoch | float - ansible_date_time.epoch | float }}.

- name: Debug the seconds remaining until certificate expiration
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  debug:
    msg: >
      Seconds remaining until expiration: {{ certificate_expiration_epoch | float - ansible_date_time.epoch | float }}

- name: Calculate remaining days until certificate expiration
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  set_fact:
    certificate_expire_in_days: >-
      {{ certificate_expiration_epoch | float - ansible_date_time.epoch | float / 86400 | round(2) }}

- name: Debug the rounded value of certificate_expire_in_days
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  debug:
    msg: >
      The rounded value of certificate_expire_in_days is: {{ certificate_expire_in_days | float }} days.

- name: Fail if certificate is expired or expires soon
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  fail:
    msg: >
      {% if certificate_expire_in_days | float == 0 %}
      The specified certificate fullchain {{ certificate_file_fullchain }} expires today!
      {% elif certificate_expire_in_days | float < 0 %}
      The specified certificate fullchain {{ certificate_file_fullchain }} expired {{ certificate_expire_in_days | float | abs | round(2) }} days ago!
      {% else %}
      The specified certificate fullchain {{ certificate_file_fullchain }} will expire in {{ certificate_expire_in_days | float | round(2) }} days!
      {% endif %}
  when: certificate_expire_in_days | float < 30

- name: Generate KeyStore
  tags:
    - cert_deploy
  delegate_to: kafka-node-0
  run_once: true
  shell: >
    openssl pkcs12 -export
    -in {{ certificate_file_fullchain }}
    -inkey {{ certificate_file_key }}
    -out {{ certificate_file_p12 }}
    -name {{ certificate_host }}
    -password pass:keystorepassword
